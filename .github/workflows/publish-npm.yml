name: Publish to NPM

on:
  push:
    branches:
      - main
      - rc
      - beta
      - next 
  workflow_dispatch:

jobs:
  publish:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

      - name: Build project
        run: pnpm build:prod

      - name: Determine version and tag
        id: version
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          DATE=$(date +'%Y%m%d')

          case $BRANCH_NAME in
            "main")
              NPM_TAG="latest"
              VERSION=$PACKAGE_VERSION
              ;;
            "rc"|"beta"|"next")
              IDENTIFIER=$BRANCH_NAME
              NPM_TAG=$BRANCH_NAME

              # Find the latest tag matching this package + identifier + date
              LAST_TAG=$(git tag --list "v${PACKAGE_VERSION}-${IDENTIFIER}.${DATE}*" | sort -V | tail -n1)

              if [ -z "$LAST_TAG" ]; then
                RUN_NUMBER=1
              else
                LAST_RUN_NUMBER=$(echo $LAST_TAG | sed -E "s/.*\.${DATE}([0-9]+)$/\1/")
                RUN_NUMBER=$((10#$LAST_RUN_NUMBER + 1))
              fi

              VERSION="${PACKAGE_VERSION}-${IDENTIFIER}.${DATE}$(printf "%03d" $RUN_NUMBER)"
              ;;
            *)
              echo "Branch $BRANCH_NAME is not configured for publishing"
              exit 1
              ;;
          esac

          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

          echo "Publishing version $VERSION with tag $NPM_TAG from branch $BRANCH_NAME"

      - name: Update package version
        run: |
          pnpm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Create distribution archive
        run: |
          # Create a compressed archive of the dist directory
          tar -czf dist-${{ steps.version.outputs.version }}.tar.gz dist/
          
          # Create a zip archive as well for Windows users
          zip -r dist-${{ steps.version.outputs.version }}.zip dist/

      - name: Publish to NPM
        run: |
          pnpm publish --tag ${{ steps.version.outputs.npm_tag }} --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release (main branch only)
        if: github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          commit: ${{ github.sha }}
          artifacts: |
            dist-${{ steps.version.outputs.version }}.tar.gz
            dist-${{ steps.version.outputs.version }}.zip
          body: |
            ## Changes
            
            This release includes all changes from the latest stable version.

            ### Installation
            ```bash
            npm install sqm@latest
            ```

            Download the distribution archives:
            - dist-${{ steps.version.outputs.version }}.tar.gz `compressed tar.gz archive`
            - dist-${{ steps.version.outputs.version }}.zip `zip archive`

            For full changelog, see the commit history.
          draft: false
          prerelease: false
          generateReleaseNotes: true

      - name: Create Pre-release (rc, beta, next branches)
        if: github.ref != 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.branch }} v${{ steps.version.outputs.version }}
          commit: ${{ github.sha }}
          artifacts: |
            dist-${{ steps.version.outputs.version }}.tar.gz
            dist-${{ steps.version.outputs.version }}.zip
          body: |
            ## ${{ steps.version.outputs.branch }} Release

            This is a pre-release version for testing purposes.

            ### Installation
            ```bash
            npm install sqm@${{ steps.version.outputs.npm_tag }}
            ```

            Download the distribution archives:
            - dist-${{ steps.version.outputs.version }}.tar.gz `compressed tar.gz archive`
            - dist-${{ steps.version.outputs.version }}.zip `zip archive`

            **⚠️ Warning**: This is a pre-release version and may contain bugs or incomplete features.
          draft: false
          prerelease: true
          generateReleaseNotes: true

      - name: Comment on related issues (main branch only)
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 50
            });

            console.log(`Starting to process commits for issue references...`);
            
            const issueNumbers = new Set();
           
            // Look for issue references in commit messages, excluding merge commits
            commits.forEach(commit => {
              const message = commit.commit.message;
              
              // Skip merge commits to avoid false positives
              if (message.startsWith('Merge pull request') || message.startsWith('Merge branch')) {
                return;
              }
              
              const issuePattern = /#(\d+)/g;
              let match;
              while ((match = issuePattern.exec(message)) !== null) {
                issueNumbers.add(match[1]);
              }
            });
            
            console.log('Will process the following issue numbers:', Array.from(issueNumbers).join(', '));
            // Comment on each referenced issue
            for (const issueNumber of issueNumbers) {
              try {
                // First check if it's actually an issue (not a PR)
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                // Skip if it's a pull request
                if (issue.pull_request) {
                  console.log(`Skipping #${issueNumber} - it's a pull request, not an issue`);
                  continue;
                }
                
                // Skip if issue is already closed
                if (issue.state === 'closed') {
                  console.log(`Skipping #${issueNumber} - issue is already closed`);
                  continue;
                }
               
                // Comment on the issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `🎉 This issue has been resolved in version \`${{ steps.version.outputs.version }}\` which is now available on npm!\n\n\`\`\`bash\nnpm install sqm@latest\n\`\`\``
                });
                
                console.log(`Successfully commented on issue #${issueNumber}`);

                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });

                console.log(`Successfully closed issue #${issueNumber}`);
                
              } catch (error) {
                console.log(`Could not process issue #${issueNumber}: ${error.message}`);
              }
            }

